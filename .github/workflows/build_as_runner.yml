name: Provision & Register Runner

# æ—¢å¯ä»¥æ‰‹åŠ¨è§¦å‘ï¼Œä¹Ÿå¯ä»¥ push åˆ° main è‡ªåŠ¨è§¦å‘
on:
  workflow_dispatch:

jobs:
  provision:
    runs-on: ubuntu-latest
    env:
      API_TOKEN: ${{ secrets.API_TOKEN }}
      SSH_PRIVATE_KEY_ID: ${{ secrets.SSH_PRIVATE_KEY_ID }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: è®¾ç½® SSH ç§é’¥
        run: |
          printf '%b\n' "${{ secrets.SSH_PRIVATE_KEY }}" > private_key.pem
          chmod 600 private_key.pem

      - name: æ£€æŸ¥ AliceInit å®ä¾‹æ˜¯å¦å­˜åœ¨
        id: check-instance
        run: |
          resp=$(curl -s 'https://app.alice.ws/cli/v1/Evo/Instance' \
            -H "KP-APIToken: $API_TOKEN")
          if echo "$resp" | jq -e '.data | length > 0' > /dev/null; then
            echo "Instance already exists."
            echo "should_create=false" >> "$GITHUB_OUTPUT"
            ip=$(echo $resp | jq -r .data.[0].ipv4)
            id=$(echo $resp | jq -r .data.[0].id)
            echo "::add-mask::$ip"
            echo "::add-mask::$id"
            echo "ip=$ip" >> "$GITHUB_OUTPUT"
            echo "id=$id" >> "$GITHUB_ENV"
          else
            echo "No existing instance. Need to create."
            echo "should_create=true" >> "$GITHUB_OUTPUT"
          fi

      - name: åˆ›å»º AliceInit å®ä¾‹
        id: provision
        if: ${{ steps.check-instance.outputs.should_create == 'true' }}
        run: |
          resp=$(curl -s -X POST 'https://app.alice.ws/cli/v1/Evo/Deploy' \
            -H "KP-APIToken: $API_TOKEN" \
            --form "product_id=39" \
            --form "os_id=10" \
            --form "time=4" \
            --form "sshKey=$SSH_PRIVATE_KEY_ID")
          data=$(echo "$resp" | jq -r .data)
          ip=$(echo "$data" | jq -r .ipv4)
          id=$(echo "$data" | jq -r .id)
          echo "::add-mask::$ip"
          echo "::add-mask::$id"
          echo "ip=$ip" >> "$GITHUB_OUTPUT"
          echo "id=$id" >> "$GITHUB_ENV"
          sleep 60s

      - name: è·å–å®ä¾‹ IP
        id: get_ip
        run: |
          if [ -n "${{ steps.check-instance.outputs.ip }}" ]; then
            echo "ip=${{ steps.check-instance.outputs.ip }}" >> "$GITHUB_OUTPUT"
          else
            echo "ip=${{ steps.provision.outputs.ip }}" >> "$GITHUB_OUTPUT"
          fi

      - name: ç­‰å¾…å®ä¾‹ SSH å°±ç»ª
        id: register-runner
        run: |
          ip="${{ steps.get_ip.outputs.ip }}"

          # ç­‰å¾… SSH å¯ç”¨
          echo "Waiting for SSH on $ip..."
          
          for i in {1..10}; do
            if ssh -o BatchMode=yes \
                   -o ConnectTimeout=5 \
                   -o StrictHostKeyChecking=no \
                   -i private_key.pem \
                   root@"$ip" "echo ready" &> /dev/null; then
              echo "âœ… SSH ready"
              break
            else
              echo "â³ SSH not ready yet ($i/10)..."
              sleep 5
            fi
          done

#      - name: Reinstall the system
#        run: |
#              ip=${{ steps.get_ip.outputs.ip }}
#              ssh -o StrictHostKeyChecking=no -i private_key.pem root@$ip << 'EOF'
#               curl -O https://raw.githubusercontent.com/bin456789/reinstall/main/reinstall.sh || wget -O reinstall.sh $_
#               bash reinstall.sh ubuntu 22.04 --ssh-key /root/.ssh/authorized_keys
#               shutdown -r -t 5
#              EOF
#              echo "ç³»ç»Ÿé‡è£…å‘½ä»¤å·²å‘é€ï¼Œç­‰å¾…å®ä¾‹é‡å¯..."
#              sleep 5m
#
#              # ç­‰å¾… SSH å¯ç”¨
#              echo "Waiting for SSH on $ip..."
#
#              for i in {1..10}; do
#                if ssh -o BatchMode=yes \
#                       -o ConnectTimeout=5 \
#                       -o StrictHostKeyChecking=no \
#                       -i private_key.pem \
#                       root@"$ip" "echo ready" &> /dev/null; then
#                  echo "âœ… SSH ready"
#                  break
#                else
#                  echo "â³ SSH not ready yet ($i/10)..."
#                  sleep 5
#                fi
#              done
      - name: Build on Remote
        id: build
        run: |
          echo "å¼€å§‹åœ¨è¿œç¨‹å®ä¾‹ä¸Šå®‰è£…å¹¶æ³¨å†Œ Runner..."
          ip=${{ steps.get_ip.outputs.ip }}
          ssh -o StrictHostKeyChecking=no -i private_key.pem root@"$ip" << "EOF"
                      apt update && apt upgrade -y && apt install -y curl tar xz-utils git jq unzip snapd docker-compose
            if pgrep -f "Runner.Listener run" >/dev/null 2>&1; then
            echo "ğŸ›‘ Runner å·²åœ¨è¿è¡Œï¼Œè·³è¿‡å¯åŠ¨ã€‚"
            exit 0
            fi
            echo 127.0.0.1 $(hostname) >> /etc/hosts
            # git clone https://github.com/actions/runner-images && cd runner-images/images/ubuntu/scripts/build
            # mv ../helpers/* /
            # mv ../../toolsets/toolset-2204.json /toolset.json
            # for file in *.sh; do chmod +x "$file";./"$file"||true;done
            # cd ../../../../../
            # åˆ›å»ºç›®å½•å¹¶ä¸‹è½½ runner

            LATEST_URL=$(curl -s https://api.github.com/repos/actions/runner/releases/latest \
                         | jq -r .assets[] \
                         | grep 'actions-runner-linux-x64-' \
                         | head -n 2 \
                         | cut -d '"' -f 4)
            wget -q $LATEST_URL
            TAR_NAME=$(basename "$LATEST_URL")
            tar xzf "$TAR_NAME"
            rm "$TAR_NAME"
            REG_TOKEN=$(curl -s -X POST \
              -H "Accept: application/json" \
              -H "Authorization: token ${{ secrets.GH_TOKEN }}" \
              https://api.github.com/repos/${{ vars.REPO }}/actions/runners/registration-token \
              | jq -r .token)
            # é…ç½® runner
            export RUNNER_ALLOW_RUNASROOT=1
            ./config.sh --url https://github.com/${{ vars.REPO }} \
                        --token $REG_TOKEN \
                        --unattended \
                        --labels self-hosted
        
            # åå°å¯åŠ¨ runner
            nohup ./run.sh > /dev/null 2>&1 &
            echo "Runner å¯åŠ¨å®Œæ¯•ï¼Œæ­£åœ¨ç›‘å¬ä½œä¸šé˜Ÿåˆ—..."

            exit
          EOF

      - name: é€šçŸ¥åç»­ï¼šè§¦å‘ â€œåœ¨ Self-hosted ä¸Šæ‰§è¡Œ Buildâ€ å·¥ä½œæµ
        if: ${{ vars.WORKFLOW != '' }}
        run: |
          echo "è§¦å‘ build-on-selfhosted.yml"
          branch=${{ vars.BRANCH }}
          curl -s -X POST \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: token ${{ secrets.GH_TOKEN }}" \
            https://api.github.com/repos/${{ vars.REPO }}/actions/workflows/${{ vars.WORKFLOW }}/dispatches \
            -d '{"ref":"'$branch'"}'

      - name: è¾“å‡ºä¿¡æ¯
        run: |
          echo "âœ”ï¸ å·²ç»åœ¨è¿œç¨‹å®ä¾‹ä¸Šæ³¨å†Œ Runner å¹¶è§¦å‘ç¬¬äºŒé˜¶æ®µå·¥ä½œæµã€‚"