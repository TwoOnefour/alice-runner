name: Remote Build via AliceInit

on:
  workflow_dispatch:
permissions:
  contents: write
  actions: write

jobs:
  provision:
    runs-on: ubuntu-latest
    env:
      API_TOKEN: ${{ secrets.API_TOKEN }}
      SSH_PRIVATE_KEY_ID: ${{ secrets.SSH_PRIVATE_KEY_ID }}
      SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
      WORKFLOW_FILE: ${{ vars.WORKFLOW }} # workflowsæ–‡ä»¶å…¨å(å¦‚xxx.yml)æˆ–è€…workflowçš„name
      PRODUCT_ID: ${{ vars.PRODUCT_ID || 38 }}
      INSTANCE_DURATION: ${{ vars.INSTRANCE_DURATION || 2 }}
      OS_ID: ${{ vars.OS_ID || 10 }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: check env
        run: |
          [ -z $API_TOKEN ] && echo "API_TOKENå¯†é’¥ä¸å­˜åœ¨" && exit 1
          [ -z $SSH_PRIVATE_KEY ] && echo "SSH_PRIVATE_KEYå¯†é’¥ä¸å­˜åœ¨" && exit 1
          [ -z $SSH_PRIVATE_KEY_ID ] && echo "SSH_PRIVATE_KEY_IDå¯†é’¥ä¸å­˜åœ¨" && exit 1
          [ -z $WORKFLOW_FILE ] && echo "WORKFLOW_FILEå˜é‡ä¸å­˜åœ¨" && exit 1
          [ -z ${{ secrets.GH_TOKEN }} ] && echo "GH_TOKENå¯†é’¥ä¸å­˜åœ¨" && exit 1

      - name: è®¾ç½® SSH ç§é’¥
        run: |
          printf '%b\n' "$SSH_PRIVATE_KEY" > private_key.pem
          chmod 600 private_key.pem

      - name: æ£€æŸ¥ AliceInit å®ä¾‹æ˜¯å¦å­˜åœ¨
        id: check-instance
        run: |
          resp=$(curl -s 'https://app.alice.ws/cli/v1/Evo/Instance' \
            -H "Authorization: Bearer $API_TOKEN")
          if echo "$resp" | jq -e '.data | length > 0' > /dev/null; then
            echo "Instance already exists."
            echo "should_create=false" >> "$GITHUB_OUTPUT"
            ip=$(echo $resp | jq -r .data.[0].ipv4)
            id=$(echo $resp | jq -r .data.[0].id)
            echo "::add-mask::$ip"
            echo "::add-mask::$id"
            echo "ip=$ip" >> "$GITHUB_OUTPUT"
            echo "id=$id" >> "$GITHUB_ENV"
          else
            echo "No existing instance. Need to create."
            echo "should_create=true" >> "$GITHUB_OUTPUT"
          fi

      - name: åˆ›å»º AliceInit å®ä¾‹
        id: provision
        if: ${{ steps.check-instance.outputs.should_create == 'true' }}
        run: |
          resp=$(curl -s -X POST 'https://app.alice.ws/cli/v1/Evo/Deploy' \
            -H "Authorization: Bearer $API_TOKEN" \
            --form "product_id=$PRODUCT_ID" \
            --form "os_id=$OS_ID" \
            --form "time=$INSTANCE_DURATION" \
            --form "sshKey=$SSH_PRIVATE_KEY_ID")
          data=$(echo "$resp" | jq -r .data)
          ip=$(echo "$data" | jq -r .ipv4)
          id=$(echo "$data" | jq -r .id)
          echo "::add-mask::$ip"
          echo "::add-mask::$id"
          echo "ip=$ip" >> "$GITHUB_OUTPUT"
          echo "id=$id" >> "$GITHUB_ENV"
          sleep 60s

      - name: è·å–å®ä¾‹ IP
        id: get_ip
        run: |
          if [ -n "${{ steps.check-instance.outputs.ip }}" ]; then
            echo "ip=${{ steps.check-instance.outputs.ip }}" >> "$GITHUB_OUTPUT"
          else
            echo "ip=${{ steps.provision.outputs.ip }}" >> "$GITHUB_OUTPUT"
          fi

      - name: ç­‰å¾…å®ä¾‹ SSH å°±ç»ª
        id: register-runner
        run: |
          ip="${{ steps.get_ip.outputs.ip }}"

          # ç­‰å¾… SSH å¯ç”¨
          echo "Waiting for SSH on $ip..."
          
          for i in {1..10}; do
            if ssh -o BatchMode=yes \
                   -o ConnectTimeout=5 \
                   -o StrictHostKeyChecking=no \
                   -i private_key.pem \
                   root@"$ip" "echo ready" &> /dev/null; then
              echo "âœ… SSH ready"
              break
            else
              echo "â³ SSH not ready yet ($i/10)..."
              sleep 5
            fi
          done

      - name: Build on Remote
        id: build
        run: |
          echo "å¼€å§‹åœ¨è¿œç¨‹å®ä¾‹ä¸Šå®‰è£…å¹¶æ³¨å†Œ Runner..."
          ip=${{ steps.get_ip.outputs.ip }}
          ssh -o StrictHostKeyChecking=no -i private_key.pem root@"$ip" << "EOF"
                      if pgrep -f "Runner.Listener run" >/dev/null 2>&1; then
                        echo "ğŸ›‘ Runner å·²åœ¨è¿è¡Œï¼Œè·³è¿‡å¯åŠ¨ã€‚"
                        exit 0
                      fi
                      echo $REG_TOKEN
                      # --- å¯é€‰ï¼šè‡ªå®šä¹‰ç”¨æˆ·ä¸ç›®å½• ---
                      RUNNER_USER="${RUNNER_USER:-ghrunner}"
                      RUNNER_DIR="/home/${RUNNER_USER}/actions-runner"
                      
                      if [[ $EUID -ne 0 ]]; then
                        echo "è¯·ç”¨ root æˆ– sudo è¿è¡Œæ­¤è„šæœ¬" >&2
                        exit 1
                      fi
                      
                      # --- å®‰è£…ä¾èµ– ---
                      if command -v apt-get >/dev/null 2>&1; then
                        apt-get update -y
                        DEBIAN_FRONTEND=noninteractive apt-get install -y sudo curl jq wget tar
                      elif command -v dnf >/dev/null 2>&1; then
                        dnf install -y sudo curl jq wget tar
                      elif command -v yum >/dev/null 2>&1; then
                        yum install -y sudo curl jq wget tar
                      else
                        echo "æœªè¯†åˆ«çš„å‘è¡Œç‰ˆï¼Œè¯·é¢„å…ˆå®‰è£…ï¼šsudo curl jq wget tar" >&2
                        exit 1
                      fi

                      if ! id -u "$RUNNER_USER" >/dev/null 2>&1; then
                        useradd -m -s /bin/bash "$RUNNER_USER"
                      fi
                    
                      # --- å‡†å¤‡ Runner ç›®å½• ---
                      install -d -o "$RUNNER_USER" -g "$RUNNER_USER" -m 755 "$RUNNER_DIR"

                      TMP=$(mktemp)
                      printf '%s\n' \
                        "Cmnd_Alias APTCMDS = /usr/bin/apt, /usr/bin/apt-get, /usr/bin/dpkg, /usr/bin/systemctl, /usr/bin/tee, /usr/bin/timedatectl" \
                        "$RUNNER_USER ALL=(ALL:ALL) NOPASSWD: APTCMDS" \
                        "Defaults:$RUNNER_USER env_keep += \"DEBIAN_FRONTEND TZ\"" \
                      | sudo tee "$TMP" >/dev/null
                      
                      # æ ¡éªŒè¯­æ³•åå†å®‰è£…
                      if visudo -cf "$TMP" >/dev/null; then
                        install -m 440 "$TMP" "/etc/sudoers.d/90-$RUNNER_USER-apt"
                        rm -f "$TMP"
                      else
                        echo "sudoers è¯­æ³•æ£€æŸ¥å¤±è´¥ï¼Œæœªå®‰è£…è§„åˆ™" >&2
                        rm -f "$TMP"; exit 1
                      fi
                      # --- ä»¥é root ç”¨æˆ·æ‰§è¡Œä½ çš„ Runner å®‰è£…/æ³¨å†Œ/å¯åŠ¨ç‰‡æ®µ ---
                      # è¯´æ˜ï¼šè¿™é‡Œæ”¹ç”¨æ›´ç¨³çš„ jq è¿‡æ»¤æ‹¿åˆ° linux-x64 çš„ tar.gz ä¸‹è½½åœ°å€
                      sudo -iu "$RUNNER_USER" bash <<'EOF'

                        umask 022
                        cd "$HOME/actions-runner"
                        # 1) ä¸‹è½½æœ€æ–°ç‰ˆ actions/runner (linux-x64)
                        LATEST_URL=$(curl -s https://api.github.com/repos/actions/runner/releases/latest \
                          | jq -r '.assets[] | select(.name | test("actions-runner-linux-x64-.*\\.tar\\.gz$")) | .browser_download_url' \
                          | head -n 1)
                        wget -q "$LATEST_URL"
                        TAR_NAME=$(basename "$LATEST_URL")
                        tar xzf "$TAR_NAME"
                        rm -f "$TAR_NAME"
                        
                        # 2) ç”³è¯·æ³¨å†Œ tokenï¼ˆä¼˜å…ˆç”¨ç¯å¢ƒå˜é‡ï¼Œè‹¥æ— åˆ™ä½¿ç”¨å·²åœ¨ Actions ä¸­å±•å¼€çš„ä¸Šä¸‹æ–‡ï¼‰
                        REG_TOKEN=$(curl -fsSL -X POST \
                          -H "Accept: application/json" \
                          -H "Authorization: token ${GH_TOKEN:-${{ secrets.GH_TOKEN }}}" \
                          "https://api.github.com/repos/${{ github.repository }}/actions/runners/registration-token" \
                          | jq -r '.token')
                        
                        # 3) é…ç½® runner
                        ./config.sh --url "https://github.com/${{ github.repository }}" \
                                    --token "$REG_TOKEN" \
                                    --unattended \
                                    --labels self-hosted \
                                    --ephemeral
                        # 4) åå°å¯åŠ¨
                        nohup ./run.sh >/dev/null 2>&1 &
                        echo "Runner å¯åŠ¨å®Œæ¯•ï¼Œæ­£åœ¨ç›‘å¬ä½œä¸šé˜Ÿåˆ—..."
                      EOF
                      
                      echo "âœ… å·²åˆ›å»ºç”¨æˆ· ${RUNNER_USER}ï¼ˆå…·å¤‡ sudo æƒé™ï¼‰ï¼Œå¹¶ä»¥å…¶èº«ä»½å®‰è£…å¹¶å¯åŠ¨ Runnerã€‚"

                      exit
          EOF

      - name: é€šçŸ¥åç»­ï¼šè§¦å‘ â€œåœ¨ Self-hosted ä¸Šæ‰§è¡Œ Buildâ€ å·¥ä½œæµ
        run: |
          echo "è§¦å‘ build-on-selfhosted.yml"
          branch="main"
          
          curl -s -X POST \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            https://api.github.com/repos/${{ github.repository }}/actions/workflows/$WORKFLOW_FILE/dispatches \
            -d '{
                  "ref":"main",
                  "inputs":{
                   "runner_choice":"self-hosted"
                  }
                }'

      - name: è¾“å‡ºä¿¡æ¯
        run: |
          echo "âœ”ï¸ å·²ç»åœ¨è¿œç¨‹å®ä¾‹ä¸Šæ³¨å†Œ Runner å¹¶è§¦å‘ç¬¬äºŒé˜¶æ®µå·¥ä½œæµã€‚"